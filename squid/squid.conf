# =========================
# Forward proxy (Option B)
# TLS on client->proxy; HTTP to nginx
# Allow only *.kclab.site and route via nginx peer
# =========================

# --- Auth (Basic / htpasswd file) ---
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
auth_param basic realm "Proxy Authentication Required"
acl authenticated proxy_auth REQUIRED

# --- HTTPS listener for the proxy itself ---
# Use separate cert + key files. They MUST exist inside the container.
# If your build supports it, you may add:  tls-min-version=1.2
https_port 3128 tls-cert=/etc/squid/ssl/mycert.pem tls-key=/etc/squid/ssl/mykey.pem

# --- ACLs (define BEFORE use) ---
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT                # we will deny CONNECT (force HTTP origin)
acl svc dstdomain .kclab.site            # allow kclab.site and all subdomains

# --- Force requests for svc via the nginx peer (no DIRECT) ---
cache_peer nginx parent 80 0 no-query originserver name=nginx-backend
cache_peer_access nginx-backend allow svc
cache_peer_access nginx-backend deny all
never_direct allow svc

# --- Access policy (order matters) ---
http_access deny !Safe_ports
http_access deny CONNECT                  # disallow HTTPS tunneling
http_access allow authenticated svc
http_access deny all

# --- Hygiene / logging ---
cache deny all
forwarded_for on
via on
httpd_suppress_version_string on
access_log stdio:/var/log/squid/access.log
cache_log /var/log/squid/cache.log
